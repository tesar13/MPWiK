# .github/workflows/MPWiK.yml
name: MPWiK Facebook Scraper

on:
  schedule:
    - cron: "0 20 * * *"      # 21:00 Polska = 20:00 UTC
  workflow_dispatch:

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout kodu
        uses: actions/checkout@v4

      - name: Ustaw Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Instalacja zale≈ºno≈õci Python
        run: |
          python -m pip install --upgrade pip
          pip install selenium==4.25.0 requests beautifulsoup4

      # Instalacja najnowszego Google Chrome (bez zmian)
      - name: Instalacja najnowszego Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # POPRAWIONA SEKCJA ‚Äì u≈ºywa Pythona do parsowania JSON (niezawodne!)
      - name: Instalacja najnowszego Chromedrivera (via Python JSON)
        run: |
          python3 -c "
          import json
          import urllib.request
          url = 'https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json'
          with urllib.request.urlopen(url) as response:
              data = json.loads(response.read().decode())
          stable = data['channels']['stable']
          downloads = stable['downloads']['chromedriver']['linux64']
          download_url = downloads['url']
          print(download_url)
          "
          DOWNLOAD_URL=$(python3 -c "import json; import urllib.request; url = 'https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json'; with urllib.request.urlopen(url) as response: data = json.loads(response.read().decode()); stable = data['channels']['stable']; downloads = stable['downloads']['chromedriver']['linux64']; print(downloads['url'])")
          ZIP_FILE=$(basename "$DOWNLOAD_URL")
          echo "Pobieram: $DOWNLOAD_URL"
          wget -O /tmp/$ZIP_FILE "$DOWNLOAD_URL"
          unzip /tmp/$ZIP_FILE -d /tmp/
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/bin/chromedriver
          sudo chmod +x /usr/bin/chromedriver
          rm /tmp/$ZIP_FILE
          echo "Chrome version: $(google-chrome --version)"
          echo "Chromedriver version: $(chromedriver --version)"

      - name: Uruchom skrypt MPWiK
        env:
          TELEGRAM_BOT_TOKEN: 8457272120:AAG4b8uvOG2gb20raSlFP52OikwQ-5L1sT8
          TELEGRAM_CHAT_ID: 1233434142
        run: |
          python MPWiK.py

      # Potwierdzenie, ≈ºe bot siƒô uruchomi≈Ç (zawsze)
      - name: Wy≈õlij potwierdzenie na Telegrama
        if: always()
        run: |
          curl -s -X POST "https://api.telegram.org/bot8457272120:AAG4b8uvOG2gb20raSlFP52OikwQ-5L1sT8/sendMessage" \
               -d chat_id=1233434142 \
               -d parse_mode=HTML \
               -d text="<b>MPWiK scraper w≈Ça≈õnie siƒô wykona≈Ç</b> üîÑ\nüìÖ $(date '+%Y-%m-%d %H:%M') UTC\nStatus: ${{ job.status == 'success' && '‚úÖ OK' || '‚ùå B≈ÅƒÑD' }}"
